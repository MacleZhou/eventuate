

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>User guide &mdash; Eventuate</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/tabbedcode.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Eventuate" href="index.html"/>
        <link rel="next" title="Reference" href="reference.html"/>
        <link rel="prev" title="Architecture" href="architecture.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

  
	<script src="//fonts.redbullmediahouse.com/snv5vzo.js"></script>
	<script>try{Typekit.load();}catch(e){}</script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          
          <a href="index.html"><img src="_static/RedBullMediaHouse-dark.png" class="logo" /></a>
        

		
<div role="search" class="searchbox">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search Eventuate" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="overview.html#event-sourcing">Event sourcing</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#event-collaboration">Event collaboration</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#event-log">Event log</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#event-bus">Event bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#event-ordering-and-consistency">Event ordering and consistency</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#operation-based-crdts">Operation-based CRDTs</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#stream-processing-adapters">Stream processing adapters</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html#related-projects">Related projects</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#event-logs">Event logs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#replication-networks">Replication networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#replication-filters">Replication filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#storage-backends">Storage backends</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#event-sourcing">Event sourcing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#event-sourced-actors">Event-sourced actors</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#event-sourced-writers">Event-sourced writers</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#event-sourced-processors">Event-sourced processors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#event-collaboration">Event collaboration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#event-driven-communication">Event-driven communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#actor-state-replication">Actor state replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="architecture.html#event-aggregation">Event aggregation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#operation-based-crdts">Operation-based CRDTs</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#vector-clocks">Vector clocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#batching">Batching</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">User guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#event-sourced-actors">Event-sourced actors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-single-instance">Creating a single instance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-two-isolated-instances">Creating two isolated instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-two-replica-instances">Creating two replica instances</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#detecting-concurrent-updates">Detecting concurrent updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tracking-conflicting-versions">Tracking conflicting versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resolving-conflicting-versions">Resolving conflicting versions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#automated-conflict-resolution">Automated conflict resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interactive-conflict-resolution">Interactive conflict resolution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#operation-based-crdts">Operation-based CRDTs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l2"><a class="reference internal" href="#conditional-requests">Conditional requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#event-driven-communication">Event-driven communication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="reference/event-log.html">Event log</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference/event-log.html#local-event-log">Local event log</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference/event-log.html#leveldb-storage-backend">LevelDB storage backend</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference/event-log.html#cassandra-storage-backend">Cassandra storage backend</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference/event-log.html#custom-storage-backends">Custom storage backends</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-log.html#replicated-event-log">Replicated event log</a><ul>
<li class="toctree-l4"><a class="reference internal" href="reference/event-log.html#replication-endpoints">Replication endpoints</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference/event-log.html#replication-filters">Replication filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference/event-log.html#update-notifications">Update notifications</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference/event-log.html#failure-detection">Failure detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="reference/event-log.html#disaster-recovery">Disaster recovery</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-log.html#deleting-events">Deleting events</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html">Event-sourced actors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#command-handler">Command handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#state-synchronization">State synchronization</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#event-handler">Event handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#event-sourced-views">Event-sourced views</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#event-sourced-writers">Event-sourced writers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#stateful-writers">Stateful writers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#event-sourced-processors">Event-sourced processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#state-recovery">State recovery</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#backpressure">Backpressure</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#recovery-using-an-application-defined-log-sequence-number">Recovery using an application-defined log sequence number</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#snapshots">Snapshots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#storage-locations">Storage locations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#event-routing">Event routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#event-driven-communication">Event-driven communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#reliable-delivery">Reliable delivery</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#conditional-requests">Conditional requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#command-stashing">Command stashing</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#behavior-changes">Behavior changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#failure-handling">Failure handling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#circuit-breaker">Circuit breaker</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#persist-failure-handling"><code class="docutils literal notranslate"><span class="pre">persist</span></code> failure handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#persistonevent-failure-handling"><code class="docutils literal notranslate"><span class="pre">persistOnEvent</span></code> failure handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#recovery-failure-handling">Recovery failure handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#batch-write-failure-handling">Batch write failure handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#batch-replication-failure-handling">Batch replication failure handling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference/event-sourcing.html#custom-serialization">Custom serialization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#custom-event-serialization">Custom event serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#custom-snapshot-serialization">Custom snapshot serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#custom-crdt-serialization">Custom CRDT serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/event-sourcing.html#resolution-of-serializers-when-deserializing">Resolution of serializers when deserializing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="reference/configuration.html">Transport Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference/configuration.html#configuration">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="reference/configuration.html#eventuate-core">eventuate-core</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/configuration.html#eventuate-crdt">eventuate-crdt</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/configuration.html#eventuate-log-cassandra">eventuate-log-cassandra</a></li>
<li class="toctree-l3"><a class="reference internal" href="reference/configuration.html#eventuate-log-leveldb">eventuate-log-leveldb</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="adapters.html">Adapters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="adapters/stream.html">Akka Streams adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="adapters/stream.html#event-source">Event source</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/stream.html#event-writer">Event writer</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/stream.html#event-processor">Event processor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="adapters/stream.html#consuming-from-a-shared-source">Consuming from a shared source</a></li>
<li class="toctree-l4"><a class="reference internal" href="adapters/stream.html#consuming-from-multiple-sources">Consuming from multiple sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="adapters/stream.html#event-processing-progress-tracking">Event processing progress tracking</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="adapters/spark.html">Spark adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="adapters/spark.html#batch-processing">Batch processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/spark.html#stream-processing">Stream processing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="adapters/vertx.html">Vert.x adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="adapters/vertx.html#event-producers">Event producers</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/vertx.html#event-processing">Event processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/vertx.html#adapter-usage">Adapter usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/vertx.html#vert-x-publish-event-producer">Vert.x publish event producer</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/vertx.html#vert-x-point-to-point-event-producer">Vert.x point-to-point event producer</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/vertx.html#log-event-producer">Log event producer</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/vertx.html#message-codecs">Message codecs</a></li>
<li class="toctree-l3"><a class="reference internal" href="adapters/vertx.html#event-metadata">Event metadata</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api-docs.html">API docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Resources</a><ul>
<li class="toctree-l2"><a class="reference internal" href="resources.html#articles">Articles</a></li>
<li class="toctree-l2"><a class="reference internal" href="resources.html#presentations">Presentations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="download.html">Download</a><ul>
<li class="toctree-l2"><a class="reference internal" href="download.html#binaries">Binaries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="download.html#maven">Maven</a></li>
<li class="toctree-l3"><a class="reference internal" href="download.html#sbt">SBT</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="download.html#sources">Sources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developers.html">Developers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="developers.html#contributing-to-eventuate">Contributing to Eventuate</a></li>
<li class="toctree-l2"><a class="reference internal" href="developers.html#building-eventuate">Building Eventuate</a><ul>
<li class="toctree-l3"><a class="reference internal" href="developers.html#binaries">Binaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="developers.html#documentation">Documentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="project.html">Project</a><ul>
<li class="toctree-l2"><a class="reference internal" href="project.html#community">Community</a></li>
<li class="toctree-l2"><a class="reference internal" href="project.html#license">License</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-does-akka-persistence-compare-to-eventuate">How does Akka Persistence compare to Eventuate?</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html#how-can-apache-kafka-be-integrated-with-eventuate">How can Apache Kafka be integrated with Eventuate?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example-application.html">Example application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="example-application.html#domain">Domain</a></li>
<li class="toctree-l2"><a class="reference internal" href="example-application.html#replication">Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="example-application.html#interface">Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="example-application.html#running">Running</a></li>
<li class="toctree-l2"><a class="reference internal" href="example-application.html#disaster-recovery">Disaster recovery</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html"><img src="_static/RedBullMediaHouse-light.png" class="logo" /></a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li>
		<a href="index.html"><h2><span class="breadcrumbicon rbicons topfront"><i class="fa fa-calendar"></i></span>Eventuate</h2></a> &raquo;
	</li>
    
    <li>User guide</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="user-guide">
<span id="id1"></span><h1>User guide<a class="headerlink" href="#user-guide" title="Permalink to this headline">¶</a></h1>
<p>This is a brief user guide to Eventuate. It is recommended to read sections <a class="reference internal" href="overview.html#overview"><span class="std std-ref">Overview</span></a> and <a class="reference internal" href="architecture.html#architecture"><span class="std std-ref">Architecture</span></a> first. Based on simple examples, you’ll see how to</p>
<ul class="simple">
<li>implement an event-sourced actor</li>
<li>replicate actor state with event sourcing</li>
<li>detect concurrent updates to replicated state</li>
<li>track conflicts from concurrent updates</li>
<li>resolve conflicts automatically and interactively</li>
<li>make concurrent updates conflict-free with operation-based CRDTs</li>
<li>implement an event-sourced view over many event-sourced actors</li>
<li>achieve causal read consistency across event-sourced actors and views and</li>
<li>implement event-driven communication between event-sourced actors.</li>
</ul>
<p>The user guide only scratches the surface of Eventuate. You can find further details in the <a class="reference internal" href="reference.html#reference"><span class="std std-ref">Reference</span></a>.</p>
<div class="section" id="event-sourced-actors">
<span id="guide-event-sourced-actors"></span><h2>Event-sourced actors<a class="headerlink" href="#event-sourced-actors" title="Permalink to this headline">¶</a></h2>
<p>An event-sourced actor is an actor that captures changes to its internal state as a sequence of events. It <em>persists</em> these events to an event log and <em>replays</em> them to recover internal state after a crash or a planned re-start. This is the basic idea behind <a class="reference external" href="http://martinfowler.com/eaaDev/EventSourcing.html">event sourcing</a>: instead of storing current application state, the full history of changes is stored as <em>immutable facts</em> and current state is derived from these facts.</p>
<p>Event-sourced actors distinguish between <em>commands</em> and <em>events</em>. During command processing they usually validate external commands against internal state and, if validation succeeds, write one or more events to their event log. During event processing they consume events they have written and update internal state by handling these events.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Event-sourced actors can also write new events during event processing. This is covered in section <a class="reference internal" href="#guide-event-driven-communication"><span class="std std-ref">Event-driven communication</span></a>.</p>
</div>
<p>Concrete event-sourced actors must implement the <code class="docutils literal notranslate"><span class="pre">EventsourcedActor</span></code> trait. The following <code class="docutils literal notranslate"><span class="pre">ExampleActor</span></code> maintains state of type <code class="docutils literal notranslate"><span class="pre">Vector[String]</span></code> to which entries can be appended:</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.util._</span>
<span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedActor</span>

<span class="c1">// Commands</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Print</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Append</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="c1">// Command replies</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">AppendSuccess</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">AppendFailure</span><span class="o">(</span><span class="n">cause</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">)</span>

<span class="c1">// Event</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">aggregateId</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">currentState</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Print</span> <span class="k">=&gt;</span>
      <span class="n">println</span><span class="o">(</span><span class="s">s&quot;[id = </span><span class="si">$id</span><span class="s">, aggregate id = </span><span class="si">${</span><span class="n">aggregateId</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;&lt;undefined&gt;&quot;</span><span class="o">)</span><span class="si">}</span><span class="s">] </span><span class="si">${</span><span class="n">currentState</span><span class="o">.</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span><span class="si">}</span><span class="s">&quot;</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Append</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">persist</span><span class="o">(</span><span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">AppendSuccess</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">AppendFailure</span><span class="o">(</span><span class="n">err</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">currentState</span> <span class="k">=</span> <span class="n">currentState</span> <span class="o">:+</span> <span class="n">entry</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.Props</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.AbstractEventsourcedActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.ReplicationConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.ResultHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.log.leveldb.LeveldbEventLog</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">akka.actor.ActorRef.noSender</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.lang.System.out</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.util.stream.Collectors.toList</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.util.stream.Stream.concat</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">java.util.stream.Stream.of</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">ExampleActor</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedActor</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">aggregateId</span><span class="o">;</span>

  <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>

  <span class="kd">public</span> <span class="nf">ExampleActor</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">aggregateId</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">aggregateId</span> <span class="o">=</span> <span class="n">aggregateId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getAggregateId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">aggregateId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnCommand</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Print</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">printState</span><span class="o">(</span><span class="n">id</span><span class="o">(),</span> <span class="n">currentState</span><span class="o">))</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Append</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">persist</span><span class="o">(</span><span class="k">new</span> <span class="n">Appended</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="na">entry</span><span class="o">),</span> <span class="n">ResultHandler</span><span class="o">.</span><span class="na">on</span><span class="o">(</span>
            <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">getSender</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">AppendSuccess</span><span class="o">(</span><span class="n">evt</span><span class="o">.</span><span class="na">entry</span><span class="o">),</span> <span class="n">getSelf</span><span class="o">()),</span>
            <span class="n">err</span> <span class="o">-&gt;</span> <span class="n">getSender</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">AppendFailure</span><span class="o">(</span><span class="n">err</span><span class="o">),</span> <span class="n">getSelf</span><span class="o">())</span>
        <span class="o">)))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Appended</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">append</span><span class="o">(</span><span class="n">currentState</span><span class="o">,</span> <span class="n">evt</span><span class="o">.</span><span class="na">entry</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">printState</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentState</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;[id = %s, aggregate id = %s] %s&quot;</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">getAggregateId</span><span class="o">().</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">&quot;undefined&quot;</span><span class="o">),</span>
      <span class="n">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">currentState</span><span class="o">)));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">append</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">,</span> <span class="n">T</span> <span class="n">el</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">concat</span><span class="o">(</span><span class="n">collection</span><span class="o">.</span><span class="na">stream</span><span class="o">(),</span> <span class="n">of</span><span class="o">(</span><span class="n">el</span><span class="o">)).</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Commands</span>
<span class="kd">class</span> <span class="nc">Print</span> <span class="o">{</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Append</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">entry</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Append</span><span class="o">(</span><span class="n">String</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Command replies</span>
<span class="kd">class</span> <span class="nc">AppendSuccess</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">entry</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">AppendSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">AppendFailure</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">AppendFailure</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">cause</span> <span class="o">=</span> <span class="n">cause</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Events</span>
<span class="kd">class</span> <span class="nc">Appended</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">entry</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Appended</span><span class="o">(</span><span class="n">String</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>For modifying <code class="docutils literal notranslate"><span class="pre">currentState</span></code>, applications send <code class="docutils literal notranslate"><span class="pre">Append</span></code> commands which are handled by the <code class="docutils literal notranslate"><span class="pre">onCommand</span></code> handler. From an <code class="docutils literal notranslate"><span class="pre">Append</span></code> command, the handler derives an <code class="docutils literal notranslate"><span class="pre">Appended</span></code> event and <code class="docutils literal notranslate"><span class="pre">persist</span></code>s it to the given <code class="docutils literal notranslate"><span class="pre">eventLog</span></code>. If persistence succeeds, the command sender is informed about successful processing. If persistence fails, the command sender is informed about the failure so it can retry, if needed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">onEvent</span></code> handler updates <code class="docutils literal notranslate"><span class="pre">currentState</span></code> from persisted events and is automatically called after a successful <code class="docutils literal notranslate"><span class="pre">persist</span></code>. If the actor is re-started, either after a crash or during normal application start, persisted events are replayed to <code class="docutils literal notranslate"><span class="pre">onEvent</span></code> which recovers internal state before new commands are processed.</p>
<p><code class="docutils literal notranslate"><span class="pre">EventsourcedActor</span></code> implementations must define a global unique <code class="docutils literal notranslate"><span class="pre">id</span></code> and require an <code class="docutils literal notranslate"><span class="pre">eventLog</span></code> actor reference for writing and replaying events. An event-sourced actor may also define an optional <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code> which has an impact how events are routed between event-sourced actors.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Section <a class="reference internal" href="reference/event-log.html#event-log"><span class="std std-ref">Event log</span></a> explains how to create <code class="docutils literal notranslate"><span class="pre">eventLog</span></code> actor references.</p>
</div>
<div class="section" id="creating-a-single-instance">
<h3>Creating a single instance<a class="headerlink" href="#creating-a-single-instance" title="Permalink to this headline">¶</a></h3>
<p>In the following, a single instance of <code class="docutils literal notranslate"><span class="pre">ExampleActor</span></code> is created and two <code class="docutils literal notranslate"><span class="pre">Append</span></code> commands are sent to it:</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span> <span class="o">=</span> <span class="c1">// ...</span>
<span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> <span class="c1">// ...</span>

<span class="k">val</span> <span class="n">ea1</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)))</span>

<span class="n">ea1</span> <span class="o">!</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)</span>
<span class="n">ea1</span> <span class="o">!</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">ActorSystem</span> <span class="n">system</span> <span class="o">=</span> <span class="c1">// ...</span>
<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">eventLog</span> <span class="o">=</span> <span class="c1">// ...</span>

<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">ea1</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ExampleActor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ExampleActor</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)));</span>

<span class="n">ea1</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">),</span> <span class="n">noSender</span><span class="o">());</span>
<span class="n">ea1</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">),</span> <span class="n">noSender</span><span class="o">());</span>
</pre></div>
</div>
</div>
<p>Sending a <code class="docutils literal notranslate"><span class="pre">Print</span></code> command</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">ea1</span> <span class="o">!</span> <span class="nc">Print</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ea1</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Print</span><span class="o">(),</span> <span class="n">noSender</span><span class="o">());</span>
</pre></div>
</div>
</div>
<p>should print:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>[id = 1, aggregate id = a] a,b
</pre></div>
</div>
<p>When the application is re-started, persisted events are replayed to <code class="docutils literal notranslate"><span class="pre">onEvent</span></code> which recovers <code class="docutils literal notranslate"><span class="pre">currentState</span></code>. Sending another <code class="docutils literal notranslate"><span class="pre">Print</span></code> command should print again:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>[id = 1, aggregate id = a] a,b
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In the following sections, several instances of <code class="docutils literal notranslate"><span class="pre">ExampleActor</span></code> are created. It is assumed that they share a <a class="reference internal" href="reference/event-log.html#replicated-event-log"><span class="std std-ref">Replicated event log</span></a> and are running at different <em>locations</em>.</p>
<p class="last">A shared event log is a pre-requisite for event-sourced actors to consume each other’s events. However, sharing an event log doesn’t necessarily mean broadcast communication between all actors on the same log. It is the <code class="docutils literal notranslate"><span class="pre">aggreagteId</span></code> that determines which actors consume each other’s events.</p>
</div>
</div>
<div class="section" id="creating-two-isolated-instances">
<h3>Creating two isolated instances<a class="headerlink" href="#creating-two-isolated-instances" title="Permalink to this headline">¶</a></h3>
<p>When creating two instances of <code class="docutils literal notranslate"><span class="pre">ExampleActor</span></code> with different <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code>s, they are isolated from each other, by default, and do not consume each other’s events:</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">b2</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="s">&quot;2&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)))</span>
<span class="k">val</span> <span class="n">c3</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="s">&quot;3&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;c&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)))</span>

<span class="n">b2</span> <span class="o">!</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)</span>
<span class="n">b2</span> <span class="o">!</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">)</span>

<span class="n">c3</span> <span class="o">!</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;x&quot;</span><span class="o">)</span>
<span class="n">c3</span> <span class="o">!</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;y&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ExampleActor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ExampleActor</span><span class="o">(</span><span class="s">&quot;2&quot;</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)));</span>
<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">c3</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ExampleActor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ExampleActor</span><span class="o">(</span><span class="s">&quot;3&quot;</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;c&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)));</span>

<span class="n">b2</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">),</span> <span class="n">noSender</span><span class="o">());</span>
<span class="n">b2</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">),</span> <span class="n">noSender</span><span class="o">());</span>

<span class="n">c3</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;x&quot;</span><span class="o">),</span> <span class="n">noSender</span><span class="o">());</span>
<span class="n">c3</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;y&quot;</span><span class="o">),</span> <span class="n">noSender</span><span class="o">());</span>
</pre></div>
</div>
</div>
<p>Sending two <code class="docutils literal notranslate"><span class="pre">Print</span></code> commands</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">b2</span> <span class="o">!</span> <span class="nc">Print</span>
<span class="n">c3</span> <span class="o">!</span> <span class="nc">Print</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">b2</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Print</span><span class="o">(),</span> <span class="n">noSender</span><span class="o">());</span>
<span class="n">c3</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Print</span><span class="o">(),</span> <span class="n">noSender</span><span class="o">());</span>
</pre></div>
</div>
</div>
<p>should print:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>[id = 2, aggregate id = b] a,b
[id = 3, aggregate id = c] x,y
</pre></div>
</div>
</div>
<div class="section" id="creating-two-replica-instances">
<h3>Creating two replica instances<a class="headerlink" href="#creating-two-replica-instances" title="Permalink to this headline">¶</a></h3>
<p>When creating two <code class="docutils literal notranslate"><span class="pre">ExampleActor</span></code> instances with the same <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code>, they consume each other’s events <a class="footnote-reference" href="#id9" id="id2">[1]</a>.</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// created at location 1</span>
<span class="k">val</span> <span class="n">d4</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="s">&quot;4&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;d&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)))</span>

<span class="c1">// created at location 2</span>
<span class="k">val</span> <span class="n">d5</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="s">&quot;5&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;d&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)))</span>

<span class="n">d4</span> <span class="o">!</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// created at location 1</span>
<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">d4</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ExampleActor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ExampleActor</span><span class="o">(</span><span class="s">&quot;4&quot;</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;d&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)));</span>

<span class="c1">// created at location 2</span>
<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">d5</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ExampleActor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ExampleActor</span><span class="o">(</span><span class="s">&quot;5&quot;</span><span class="o">,</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;d&quot;</span><span class="o">),</span> <span class="n">eventLog</span><span class="o">)));</span>

<span class="n">d4</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">),</span> <span class="n">noSender</span><span class="o">());</span>
</pre></div>
</div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">d4</span></code> processes an <code class="docutils literal notranslate"><span class="pre">Append</span></code> command and persists an <code class="docutils literal notranslate"><span class="pre">Appended</span></code> event. Both, <code class="docutils literal notranslate"><span class="pre">d4</span></code> and <code class="docutils literal notranslate"><span class="pre">d5</span></code>, consume that event and update their internal state. After waiting a bit for convergence, sending a <code class="docutils literal notranslate"><span class="pre">Print</span></code> command to both actors should print:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>[id = 4, aggregate id = d] a
[id = 5, aggregate id = d] a
</pre></div>
</div>
<p>After both replicas have converged, another <code class="docutils literal notranslate"><span class="pre">Append</span></code> is sent to <code class="docutils literal notranslate"><span class="pre">d5</span></code>.</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">d5</span> <span class="o">!</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">d5</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">),</span> <span class="n">noSender</span><span class="o">());</span>
</pre></div>
</div>
</div>
<p>Again both actors consume the event and sending another <code class="docutils literal notranslate"><span class="pre">Print</span></code> command should print:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>[id = 4, aggregate id = d] a,b
[id = 5, aggregate id = d] a,b
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>As you have probably recognized, replica convergence in this example can only be achieved if the second <code class="docutils literal notranslate"><span class="pre">Append</span></code> command is sent after both actors have processed the <code class="docutils literal notranslate"><span class="pre">Appended</span></code> event from the first <code class="docutils literal notranslate"><span class="pre">Append</span></code> command.</p>
<p>In other words, the first <code class="docutils literal notranslate"><span class="pre">Appended</span></code> event must <em>happen before</em> the second one. Only in this case, these two events can have a causal relationship. Since events are guaranteed to be delivered in potential causal order to all replicas, they can converge to the same state.</p>
<p class="last">When concurrent updates are made to both replicas, the corresponding <code class="docutils literal notranslate"><span class="pre">Appended</span></code> events are not causally related and can be delivered in any order to both replicas. This may cause replicas to diverge because <em>append</em> operations do not commute. The following sections give examples how to detect and handle concurrent updates.</p>
</div>
</div>
</div>
<div class="section" id="detecting-concurrent-updates">
<h2>Detecting concurrent updates<a class="headerlink" href="#detecting-concurrent-updates" title="Permalink to this headline">¶</a></h2>
<p>Eventuate tracks <em>happened-before</em> relationships (= potential causality) of events with <a class="reference internal" href="architecture.html#vector-clocks"><span class="std std-ref">Vector clocks</span></a>. Why is that needed at all? Let’s assume that an event-sourced actor emits an event <code class="docutils literal notranslate"><span class="pre">e1</span></code> for changing internal state and later receives an event <code class="docutils literal notranslate"><span class="pre">e2</span></code> from a replica instance. If the replica instance emits <code class="docutils literal notranslate"><span class="pre">e2</span></code> after having processed <code class="docutils literal notranslate"><span class="pre">e1</span></code>, the actor can apply <code class="docutils literal notranslate"><span class="pre">e2</span></code> as regular update. If the replica instance emits <code class="docutils literal notranslate"><span class="pre">e2</span></code> before having received <code class="docutils literal notranslate"><span class="pre">e1</span></code>, the actor receives a concurrent, potentially conflicting event.</p>
<p>How can the actor determine if <code class="docutils literal notranslate"><span class="pre">e2</span></code> is a regular i.e. causally related or concurrent update? It can do so by comparing the vector timestamps of <code class="docutils literal notranslate"><span class="pre">e1</span></code> and <code class="docutils literal notranslate"><span class="pre">e2</span></code>, where <code class="docutils literal notranslate"><span class="pre">t1</span></code> is the vector timestamp of <code class="docutils literal notranslate"><span class="pre">e1</span></code> and <code class="docutils literal notranslate"><span class="pre">t2</span></code> the vector timestamp of <code class="docutils literal notranslate"><span class="pre">e2</span></code>. If events <code class="docutils literal notranslate"><span class="pre">e1</span></code> and <code class="docutils literal notranslate"><span class="pre">e2</span></code> are concurrent then <code class="docutils literal notranslate"><span class="pre">t1</span> <span class="pre">conc</span> <span class="pre">t2</span></code> evaluates to <code class="docutils literal notranslate"><span class="pre">true</span></code>. Otherwise, they are causally related and <code class="docutils literal notranslate"><span class="pre">t1</span> <span class="pre">&lt;</span> <span class="pre">t2</span></code> evaluates to <code class="docutils literal notranslate"><span class="pre">true</span></code> (because <code class="docutils literal notranslate"><span class="pre">e1</span></code> <em>happened-before</em> <code class="docutils literal notranslate"><span class="pre">e2</span></code>).</p>
<p>The vector timestamp of an event can be obtained with <code class="docutils literal notranslate"><span class="pre">lastVectorTimestamp</span></code> during event processing. Vector timestamps can be attached as <em>update timestamp</em> to current state and compared with the vector timestamp of a new event in order to determine whether the new event is causally related to the previous state update or not<a class="footnote-reference" href="#id10" id="id3">[2]</a>:</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedActor</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.VectorTime</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">aggregateId</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">currentState</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">updateTimestamp</span><span class="k">:</span> <span class="kt">VectorTime</span> <span class="o">=</span> <span class="nc">VectorTime</span><span class="o">()</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// ...</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">updateTimestamp</span> <span class="o">&lt;</span> <span class="n">lastVectorTimestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// regular update</span>
        <span class="n">currentState</span> <span class="k">=</span> <span class="n">currentState</span> <span class="o">:+</span> <span class="n">entry</span>
        <span class="n">updateTimestamp</span> <span class="k">=</span> <span class="n">lastVectorTimestamp</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">updateTimestamp</span> <span class="n">conc</span> <span class="n">lastVectorTimestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// concurrent update</span>
        <span class="c1">// TODO: track conflicting versions</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.AbstractEventsourcedActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.VectorTime</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">ExampleActor</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedActor</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="kd">private</span> <span class="n">VectorTime</span> <span class="n">updateTimestamp</span> <span class="o">=</span> <span class="n">VectorTime</span><span class="o">.</span><span class="na">Zero</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">ExampleActor</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Appended</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">updateTimestamp</span><span class="o">.</span><span class="na">lt</span><span class="o">(</span><span class="n">getLastVectorTimestamp</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="c1">// regular update</span>
                    <span class="n">currentState</span> <span class="o">=</span> <span class="n">append</span><span class="o">(</span><span class="n">currentState</span><span class="o">,</span> <span class="n">evt</span><span class="o">.</span><span class="na">entry</span><span class="o">);</span>
                    <span class="n">updateTimestamp</span> <span class="o">=</span> <span class="n">getLastVectorTimestamp</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">updateTimestamp</span><span class="o">.</span><span class="na">conc</span><span class="o">(</span><span class="n">getLastVectorTimestamp</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="c1">// concurrent update</span>
                    <span class="c1">// TODO: track conflicting versions</span>
                <span class="o">}</span>
            <span class="o">})</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Attaching update timestamps to current state and comparing them with vector timestamps of new events can be easily abstracted over so that applications don’t have to deal with these low level details, as shown in the next section.</p>
</div>
<div class="section" id="tracking-conflicting-versions">
<span id="id4"></span><h2>Tracking conflicting versions<a class="headerlink" href="#tracking-conflicting-versions" title="Permalink to this headline">¶</a></h2>
<p>If state update operations from concurrent events do not commute, conflicting versions of actor state arise that must be tracked and resolved. This can be done with Eventuate’s <code class="docutils literal notranslate"><span class="pre">ConcurrentVersions[S,</span> <span class="pre">A]</span></code> abstraction and an application-defined <em>update function</em> of type <code class="docutils literal notranslate"><span class="pre">(S,</span> <span class="pre">A)</span> <span class="pre">=&gt;</span> <span class="pre">S</span></code> where <code class="docutils literal notranslate"><span class="pre">S</span></code> is the type of actor state and <code class="docutils literal notranslate"><span class="pre">A</span></code> the update type. In our example, the <code class="docutils literal notranslate"><span class="pre">ConcurrentVersions</span></code> type is <code class="docutils literal notranslate"><span class="pre">ConcurrentVersions[Vector[String],</span> <span class="pre">String]</span></code> and the update function <code class="docutils literal notranslate"><span class="pre">(s,</span> <span class="pre">a)</span> <span class="pre">=&gt;</span> <span class="pre">s</span> <span class="pre">:+</span> <span class="pre">a</span></code>:</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.collection.immutable.Seq</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.</span><span class="o">{</span><span class="nc">ConcurrentVersions</span><span class="o">,</span> <span class="nc">Versioned</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedActor</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">aggregateId</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">versionedState</span><span class="k">:</span> <span class="kt">ConcurrentVersions</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">ConcurrentVersions</span><span class="o">(</span><span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s</span> <span class="o">:+</span> <span class="n">a</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// ...</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">versionedState</span> <span class="k">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">entry</span><span class="o">,</span> <span class="n">lastVectorTimestamp</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">versionedState</span><span class="o">.</span><span class="n">conflict</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">conflictingVersions</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Versioned</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]]]</span> <span class="k">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="n">all</span>
        <span class="c1">// TODO: resolve conflicting versions</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">currentState</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">value</span>
        <span class="c1">// ...</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">ExampleActor</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedActor</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">ConcurrentVersions</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">versionedState</span> <span class="o">=</span>
    <span class="n">ConcurrentVersionsTree</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">(),</span> <span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">append</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">));</span>

  <span class="kd">public</span> <span class="nf">ExampleActor</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
          <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Appended</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="n">versionedState</span> <span class="o">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">evt</span><span class="o">.</span><span class="na">entry</span><span class="o">,</span> <span class="n">getLastVectorTimestamp</span><span class="o">(),</span> <span class="n">getLastSystemTimestamp</span><span class="o">(),</span> <span class="n">getLastEmitterId</span><span class="o">());</span>

              <span class="k">if</span> <span class="o">(</span><span class="n">versionedState</span><span class="o">.</span><span class="na">conflict</span><span class="o">())</span> <span class="o">{</span>
                  <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Versioned</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">all</span> <span class="o">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">getAll</span><span class="o">();</span>
                  <span class="c1">// TODO: resolve conflicting versions</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">value</span><span class="o">();</span>
                  <span class="c1">// ...</span>
              <span class="o">}</span>
          <span class="o">})</span>
          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Internally, <code class="docutils literal notranslate"><span class="pre">ConcurrentVersions</span></code> maintains versions of actor state in a tree structure where each concurrent <code class="docutils literal notranslate"><span class="pre">update</span></code> creates a new branch. The shape of the tree is determined solely by the vector timestamps of the corresponding update events.</p>
<p>An event’s vector timestamp is passed as <code class="docutils literal notranslate"><span class="pre">lastVectorTimestamp</span></code> argument to <code class="docutils literal notranslate"><span class="pre">update</span></code>. The <code class="docutils literal notranslate"><span class="pre">update</span></code> method internally creates a new version by applying the update function <code class="docutils literal notranslate"><span class="pre">(s,</span> <span class="pre">a)</span> <span class="pre">=&gt;</span> <span class="pre">s</span> <span class="pre">:+</span> <span class="pre">a</span></code> to the closest predecessor version and the actual update value (<code class="docutils literal notranslate"><span class="pre">entry</span></code>). The <code class="docutils literal notranslate"><span class="pre">lastVectorTimestamp</span></code> is attached as update timestamp to the newly created version.</p>
<p>Concurrent versions of actor state and their update timestamp can be obtained with <code class="docutils literal notranslate"><span class="pre">all</span></code> which is a sequence of type <code class="docutils literal notranslate"><span class="pre">Seq[Versioned[Vector[String]]]</span></code> in our example. The <a class="reference external" href="latest/api/index.html#com.rbmhtechnology.eventuate.Versioned">Versioned</a> data type represents a particular version of actor state and its update timestamp (= <code class="docutils literal notranslate"><span class="pre">vectorTimestamp</span></code> field).</p>
<p>If <code class="docutils literal notranslate"><span class="pre">all</span></code> contains only a single element, there is no conflict and the element represents the current, conflict-free actor state. If the sequence contains two or more elements, there is a conflict where the elements represent conflicting versions of actor states. They can be resolved either automatically or interactively.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Only concurrent updates to replicas with the same <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code> may conflict. Concurrent updates to actors with different <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code> do not conflict (unless an application does custom <a class="reference internal" href="reference/event-sourcing.html#event-routing"><span class="std std-ref">Event routing</span></a>).</p>
<p class="last">Also, if the data type of actor state is designed in a way that update operations commute, concurrent updates can be made conflict-free. This is discussed in section <a class="reference internal" href="#commutative-replicated-data-types"><span class="std std-ref">Operation-based CRDTs</span></a>.</p>
</div>
</div>
<div class="section" id="resolving-conflicting-versions">
<h2>Resolving conflicting versions<a class="headerlink" href="#resolving-conflicting-versions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="automated-conflict-resolution">
<span id="id5"></span><h3>Automated conflict resolution<a class="headerlink" href="#automated-conflict-resolution" title="Permalink to this headline">¶</a></h3>
<p>The following is a simple example of automated conflict resolution: if a conflict has been detected, the version with the higher wall clock timestamp is selected to be the winner. In case of equal wall clock timestamps, the version with the lower emitter id is selected. The wall clock timestamp can be obtained with <code class="docutils literal notranslate"><span class="pre">lastSystemTimestamp</span></code> during event handling, the emitter id with <code class="docutils literal notranslate"><span class="pre">lastEmitterId</span></code>. The emitter id is the <code class="docutils literal notranslate"><span class="pre">id</span></code> of the <code class="docutils literal notranslate"><span class="pre">EventsourcedActor</span></code> that emitted the event.</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">aggregateId</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">versionedState</span><span class="k">:</span> <span class="kt">ConcurrentVersions</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">ConcurrentVersions</span><span class="o">(</span><span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s</span> <span class="o">:+</span> <span class="n">a</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// ...</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">versionedState</span> <span class="k">=</span> <span class="n">versionedState</span>
        <span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">entry</span><span class="o">,</span> <span class="n">lastVectorTimestamp</span><span class="o">,</span> <span class="n">lastSystemTimestamp</span><span class="o">,</span> <span class="n">lastEmitterId</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">versionedState</span><span class="o">.</span><span class="n">conflict</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">conflictingVersions</span> <span class="k">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">sortWith</span> <span class="o">{</span> <span class="o">(</span><span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">v1</span><span class="o">.</span><span class="n">systemTimestamp</span> <span class="o">==</span> <span class="n">v2</span><span class="o">.</span><span class="n">systemTimestamp</span><span class="o">)</span> <span class="n">v1</span><span class="o">.</span><span class="n">creator</span> <span class="o">&lt;</span> <span class="n">v2</span><span class="o">.</span><span class="n">creator</span>
          <span class="k">else</span> <span class="n">v1</span><span class="o">.</span><span class="n">systemTimestamp</span> <span class="o">&gt;</span> <span class="n">v2</span><span class="o">.</span><span class="n">systemTimestamp</span>
        <span class="o">}</span>
        <span class="k">val</span> <span class="n">winnerTimestamp</span><span class="k">:</span> <span class="kt">VectorTime</span> <span class="o">=</span> <span class="n">conflictingVersions</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">vectorTimestamp</span>
        <span class="n">versionedState</span> <span class="k">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="n">resolve</span><span class="o">(</span><span class="n">winnerTimestamp</span><span class="o">)</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">userguide.japi.DocUtils.append</span><span class="o">;</span>


<span class="kd">class</span> <span class="nc">ExampleActor</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedActor</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">ConcurrentVersions</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">versionedState</span> <span class="o">=</span>
    <span class="n">ConcurrentVersionsTree</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">(),</span> <span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">append</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">));</span>

  <span class="kd">public</span> <span class="nf">ExampleActor</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Appended</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="n">versionedState</span> <span class="o">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">evt</span><span class="o">.</span><span class="na">entry</span><span class="o">,</span> <span class="n">getLastVectorTimestamp</span><span class="o">(),</span> <span class="n">getLastSystemTimestamp</span><span class="o">(),</span> <span class="n">getLastEmitterId</span><span class="o">());</span>

          <span class="k">if</span> <span class="o">(</span><span class="n">versionedState</span><span class="o">.</span><span class="na">conflict</span><span class="o">())</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Versioned</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">conflictingVersions</span> <span class="o">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">sorted</span><span class="o">((</span><span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">v1</span><span class="o">.</span><span class="na">systemTimestamp</span><span class="o">()</span> <span class="o">==</span> <span class="n">v2</span><span class="o">.</span><span class="na">systemTimestamp</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">v1</span><span class="o">.</span><span class="na">creator</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">v2</span><span class="o">.</span><span class="na">creator</span><span class="o">());</span>
                  <span class="o">}</span>
                  <span class="k">return</span> <span class="n">v1</span><span class="o">.</span><span class="na">systemTimestamp</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">v2</span><span class="o">.</span><span class="na">systemTimestamp</span><span class="o">()</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="o">;</span>
                <span class="o">});</span>

            <span class="kd">final</span> <span class="n">VectorTime</span> <span class="n">winnerTimestamp</span> <span class="o">=</span> <span class="n">conflictingVersions</span><span class="o">.</span><span class="na">findFirst</span><span class="o">().</span><span class="na">get</span><span class="o">().</span><span class="na">vectorTimestamp</span><span class="o">();</span>
            <span class="n">versionedState</span> <span class="o">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">winnerTimestamp</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Here, conflicting versions are sorted by descending wall clock timestamp and ascending emitter id where the latter is tracked as <code class="docutils literal notranslate"><span class="pre">creator</span></code> of the version. The first version is selected to be the winner. Its vector timestamp is passed as argument to <code class="docutils literal notranslate"><span class="pre">resolve</span></code> which selects this version and discards all other versions.</p>
<p>More advanced conflict resolution could select a winner depending on the actual value of concurrent versions. After selection, an application could even update the winner with the <em>merged</em> value of all conflicting versions<a class="footnote-reference" href="#id11" id="id6">[3]</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For replicas to converge, it is important that winner selection does not depend on the order of conflicting events. In our example, this is the case because wall clock timestamp and emitter id comparison is transitive.</p>
</div>
</div>
<div class="section" id="interactive-conflict-resolution">
<h3>Interactive conflict resolution<a class="headerlink" href="#interactive-conflict-resolution" title="Permalink to this headline">¶</a></h3>
<p>Interactive conflict resolution does not resolve conflicts immediately but requests the user to inspect and resolve a conflict. The following is a very simple example of interactive conflict resolution: a user selects a winner version if conflicting versions of application state exist.</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Append</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">AppendRejected</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">conflictingVersions</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Versioned</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]]])</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Resolve</span><span class="o">(</span><span class="n">selectedTimestamp</span><span class="k">:</span> <span class="kt">VectorTime</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Resolved</span><span class="o">(</span><span class="n">selectedTimestamp</span><span class="k">:</span> <span class="kt">VectorTime</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">aggregateId</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">versionedState</span><span class="k">:</span> <span class="kt">ConcurrentVersions</span><span class="o">[</span><span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">ConcurrentVersions</span><span class="o">(</span><span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s</span> <span class="o">:+</span> <span class="n">a</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Append</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">if</span> <span class="n">versionedState</span><span class="o">.</span><span class="n">conflict</span> <span class="k">=&gt;</span>
      <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">AppendRejected</span><span class="o">(</span><span class="n">entry</span><span class="o">,</span> <span class="n">versionedState</span><span class="o">.</span><span class="n">all</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Append</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="c1">// ...</span>
    <span class="k">case</span> <span class="nc">Resolve</span><span class="o">(</span><span class="n">selectedTimestamp</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">persist</span><span class="o">(</span><span class="nc">Resolved</span><span class="o">(</span><span class="n">selectedTimestamp</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// reply to sender omitted ...</span>
      <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">err</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// reply to sender omitted ...</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">versionedState</span> <span class="k">=</span> <span class="n">versionedState</span>
        <span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">entry</span><span class="o">,</span> <span class="n">lastVectorTimestamp</span><span class="o">,</span> <span class="n">lastSystemTimestamp</span><span class="o">,</span> <span class="n">lastEmitterId</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Resolved</span><span class="o">(</span><span class="n">selectedTimestamp</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">versionedState</span> <span class="k">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="n">resolve</span><span class="o">(</span><span class="n">selectedTimestamp</span><span class="o">,</span> <span class="n">lastVectorTimestamp</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ExampleActor</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedActor</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">ConcurrentVersions</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">versionedState</span> <span class="o">=</span>
    <span class="n">ConcurrentVersionsTree</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">(),</span> <span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">append</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">a</span><span class="o">));</span>

  <span class="kd">public</span> <span class="nf">ExampleActor</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnCommand</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Append</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">conflict</span><span class="o">(),</span>
            <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">getSender</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">AppendRejected</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="na">entry</span><span class="o">,</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">getAll</span><span class="o">()),</span> <span class="n">getSelf</span><span class="o">())</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Append</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="c1">// ....</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Resolve</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">persist</span><span class="o">(</span><span class="k">new</span> <span class="n">Resolved</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="na">selectedTimestamp</span><span class="o">),</span> <span class="n">ResultHandler</span><span class="o">.</span><span class="na">on</span><span class="o">(</span>
            <span class="n">evt</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="cm">/* reply to sender omitted ... */</span> <span class="o">},</span>
            <span class="n">err</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="cm">/* reply to sender omitted ... */</span> <span class="o">}</span>
        <span class="o">)))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Appended</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span>
            <span class="n">versionedState</span> <span class="o">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">evt</span><span class="o">.</span><span class="na">entry</span><span class="o">,</span> <span class="n">getLastVectorTimestamp</span><span class="o">(),</span> <span class="n">getLastSystemTimestamp</span><span class="o">(),</span> <span class="n">getLastEmitterId</span><span class="o">())</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Resolved</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span>
            <span class="n">versionedState</span> <span class="o">=</span> <span class="n">versionedState</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">evt</span><span class="o">.</span><span class="na">selectedTimestamp</span><span class="o">,</span> <span class="n">getLastVectorTimestamp</span><span class="o">(),</span> <span class="n">getLastSystemTimestamp</span><span class="o">())</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Command</span>
<span class="kd">class</span> <span class="nc">Append</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">entry</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Append</span><span class="o">(</span><span class="n">String</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Command reply</span>
<span class="kd">class</span> <span class="nc">AppendRejected</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">entry</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Versioned</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">conflictingVersions</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">AppendRejected</span><span class="o">(</span><span class="n">String</span> <span class="n">entry</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Versioned</span><span class="o">&lt;</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">conflictingVersions</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">conflictingVersions</span> <span class="o">=</span> <span class="n">conflictingVersions</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Command</span>
<span class="kd">class</span> <span class="nc">Resolve</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">VectorTime</span> <span class="n">selectedTimestamp</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Resolve</span><span class="o">(</span><span class="n">VectorTime</span> <span class="n">selectedTimestamp</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">selectedTimestamp</span> <span class="o">=</span> <span class="n">selectedTimestamp</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Command reply</span>
<span class="kd">class</span> <span class="nc">Resolved</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">VectorTime</span> <span class="n">selectedTimestamp</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Resolved</span><span class="o">(</span><span class="n">VectorTime</span> <span class="n">selectedTimestamp</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">selectedTimestamp</span> <span class="o">=</span> <span class="n">selectedTimestamp</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>When a user tries to <code class="docutils literal notranslate"><span class="pre">Append</span></code> in presence of a conflict, the <code class="docutils literal notranslate"><span class="pre">ExampleActor</span></code> rejects the update and requests the user to select a winner version from a sequence of conflicting versions. The user then sends the update timestamp of the winner version as <code class="docutils literal notranslate"><span class="pre">selectedTimestamp</span></code> with a <code class="docutils literal notranslate"><span class="pre">Resolve</span></code> command from which a <code class="docutils literal notranslate"><span class="pre">Resolved</span></code> event is derived and persisted. Handling of <code class="docutils literal notranslate"><span class="pre">Resolved</span></code> at all replicas finally resolves the conflict.</p>
<p>In addition to just selecting a winner, an application could also update the winner version in a second step, for example, with a value derived from the merge result of conflicting versions. Support for <em>atomic</em>, interactive conflict resolution with an application-defined merge function is planned for later Eventuate releases.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Interactive conflict resolution requires agreement among replicas that are affected by a given conflict: only one of them may emit the <code class="docutils literal notranslate"><span class="pre">Resolved</span></code> event. This does not necessarily mean distributed lock acquisition or leader (= resolver) election but can also rely on static rules such as <em>only the initial creator location of an aggregate is allowed to resolve the conflict</em><a class="footnote-reference" href="#id12" id="id7">[4]</a>. This rule is implemented in the <a class="reference internal" href="example-application.html#example-application"><span class="std std-ref">Example application</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="operation-based-crdts">
<span id="commutative-replicated-data-types"></span><h2>Operation-based CRDTs<a class="headerlink" href="#operation-based-crdts" title="Permalink to this headline">¶</a></h2>
<p>If state update operations commute, there’s no need to use Eventuate’s <code class="docutils literal notranslate"><span class="pre">ConcurrentVersions</span></code> utility. A simple example is a replicated counter, which converges because its increment and decrement operations commute.</p>
<p>A formal to approach to commutative replicated data types (CmRDTs) or operation-based CRDTs is given in the paper <a class="reference external" href="http://hal.upmc.fr/file/index/docid/555588/filename/techreport.pdf">A comprehensive study of Convergent and Commutative Replicated Data Types</a> by Marc Shapiro et al. Eventuate is a good basis for implementing operation-based CRDTs:</p>
<ul class="simple">
<li>Update operations can be modeled as events and reliably broadcasted to all replicas by a <a class="reference internal" href="reference/event-log.html#replicated-event-log"><span class="std std-ref">Replicated event log</span></a>.</li>
<li>The command and event handler of an event-sourced actor can be used to implement the two update phases mentioned in the paper: <em>atSource</em> and <em>downstream</em>, respectively.</li>
<li>All <em>downstream</em> preconditions mentioned in the paper are satisfied in case of causal delivery of update operations which is guaranteed for actors consuming from a replicated event log.</li>
</ul>
<p>Eventuate currently implements 5 out of 12 operation-based CRDTs specified in the paper. These are <em>Counter</em>, <em>MV-Register</em>, <em>LWW-Register</em>, <em>OR-Set</em> and <em>OR-Cart</em> (a shopping cart CRDT). They can be instantiated and used via their corresponding <em>CRDT services</em>. CRDT operations are asynchronous methods on the service interfaces. CRDT services free applications from dealing with low-level details like event-sourced actors or command messages directly. The following is the definition of <a class="reference external" href="latest/api/index.html#com.rbmhtechnology.eventuate.crdt.ORSetService">ORSetService</a>:</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Replicated [[ORSet]] CRDT service.</span>
<span class="cm"> *</span>
<span class="cm"> * @param serviceId Unique id of this service.</span>
<span class="cm"> * @param log Event log.</span>
<span class="cm"> * @tparam A [[ORSet]] entry type.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">ORSetService</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">val</span> <span class="n">serviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">val</span> <span class="n">log</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)(</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span><span class="o">,</span> <span class="k">val</span> <span class="n">ops</span><span class="k">:</span> <span class="kt">CRDTServiceOps</span><span class="o">[</span><span class="kt">ORSet</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>, <span class="kt">Set</span><span class="o">[</span><span class="kt">A</span><span class="o">]])</span>
  <span class="k">extends</span> <span class="nc">CRDTService</span><span class="o">[</span><span class="kt">ORSet</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>, <span class="kt">Set</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="o">{</span>

  <span class="cm">/**</span>
<span class="cm">   * Adds `entry` to the OR-Set identified by `id` and returns the updated entry set.</span>
<span class="cm">   */</span>
  <span class="k">def</span> <span class="n">add</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">entry</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span>
    <span class="n">op</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nc">AddOp</span><span class="o">(</span><span class="n">entry</span><span class="o">))</span>

  <span class="cm">/**</span>
<span class="cm">   * Removes `entry` from the OR-Set identified by `id` and returns the updated entry set.</span>
<span class="cm">   */</span>
  <span class="k">def</span> <span class="n">remove</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">entry</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span>
    <span class="n">op</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nc">RemoveOp</span><span class="o">(</span><span class="n">entry</span><span class="o">))</span>

  <span class="n">start</span><span class="o">()</span>
<span class="o">}</span>

<span class="cm">/**</span>
<span class="cm"> * Persistent add operation used for [[ORSet]] and [[ORCart]].</span>
<span class="cm"> */</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">AddOp</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">Any</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">CRDTFormat</span>

<span class="cm">/**</span>
<span class="cm"> * Persistent remove operation used for [[ORSet]] and [[ORCart]].</span>
<span class="cm"> */</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">RemoveOp</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">Any</span><span class="o">,</span> <span class="n">timestamps</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">VectorTime</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">CRDTFormat</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Java API of a replicated [[ORSet]] CRDT service.</span>
<span class="cm"> *</span>
<span class="cm"> * @param serviceId Unique id of this service.</span>
<span class="cm"> * @param log Event log.</span>
<span class="cm"> * @param system Actor system.</span>
<span class="cm"> * @tparam A [[ORSet]] entry type.</span>
<span class="cm"> */</span>
<span class="kd">class</span> <span class="nc">ORSetService</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">CRDTService</span><span class="o">&lt;</span><span class="n">ORSet</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

  <span class="n">ORSetService</span><span class="o">(</span><span class="n">String</span> <span class="n">serviceId</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">log</span><span class="o">,</span> <span class="n">ActorSystem</span> <span class="n">system</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">serviceId</span><span class="o">,</span> <span class="n">log</span><span class="o">,</span> <span class="n">system</span><span class="o">);</span>

    <span class="n">start</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="nf">add</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">A</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="k">new</span> <span class="n">AddOp</span><span class="o">(</span><span class="n">entry</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">A</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="k">new</span> <span class="n">RemoveOp</span><span class="o">(</span><span class="n">entry</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>The <a class="reference external" href="latest/api/index.html#com.rbmhtechnology.eventuate.crdt.ORSetService">ORSetService</a> is a CRDT service that manages <a class="reference external" href="latest/api/index.html#com.rbmhtechnology.eventuate.crdt.ORSet">ORSet</a> instances. It implements the asynchronous <code class="docutils literal notranslate"><span class="pre">add</span></code> and <code class="docutils literal notranslate"><span class="pre">remove</span></code> methods and inherits the <code class="docutils literal notranslate"><span class="pre">value(id:</span> <span class="pre">String):</span> <span class="pre">Future[Set[A]]</span></code> method from <code class="docutils literal notranslate"><span class="pre">CRDTService[ORSet[A],</span> <span class="pre">Set[A]]</span></code> for reading the current value. Their <code class="docutils literal notranslate"><span class="pre">id</span></code> parameter identifies an <code class="docutils literal notranslate"><span class="pre">ORSet</span></code> instance. Instances are automatically created by the service on demand. A usage example is the <a class="reference external" href="https://github.com/RBMHTechnology/eventuate/blob/master/src/multi-jvm/scala/com/rbmhtechnology/eventuate/crdt/ReplicatedORSetSpec.scala">ReplicatedOrSetSpec</a> that is based on Akka’s <a class="reference external" href="http://doc.akka.io/docs/akka/2.4/dev/multi-node-testing.html">multi node testkit</a>.</p>
<p>A CRDT service also implements a <code class="docutils literal notranslate"><span class="pre">save(id:</span> <span class="pre">String):</span> <span class="pre">Future[SnapshotMetadata]</span></code> method for saving CRDT snapshots. <a class="reference internal" href="reference/event-sourcing.html#snapshots"><span class="std std-ref">Snapshots</span></a> may reduce recovery times of CRDTs with a long update history but are not required for CRDT persistence.</p>
<p>New operation-based CRDTs and their corresponding services can be developed with the CRDT development framework, by defining an instance of the <a class="reference external" href="latest/api/index.html#com.rbmhtechnology.eventuate.crdt.CRDTServiceOps">CRDTServiceOps</a> type class and implementing the <a class="reference external" href="latest/api/index.html#com.rbmhtechnology.eventuate.crdt.CRDTService">CRDTService</a> trait. Take a look at the <a class="reference external" href="https://github.com/RBMHTechnology/eventuate/tree/master/eventuate-crdt/src/main/scala/com/rbmhtechnology/eventuate/crdt">CRDT sources</a> for examples.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Eventuate’s CRDT approach is also described in <a class="reference external" href="http://krasserm.github.io/2016/10/19/operation-based-crdt-framework/">this article</a>.</p>
</div>
</div>
<div class="section" id="event-sourced-views">
<span id="guide-event-sourced-views"></span><h2>Event-sourced views<a class="headerlink" href="#event-sourced-views" title="Permalink to this headline">¶</a></h2>
<p>Event-sourced views are a functional subset of event-sourced actors. They can only consume events from an event log but cannot produce new events. Concrete event-sourced views must implement the <code class="docutils literal notranslate"><span class="pre">EventsourcedView</span></code> trait. In the following example, the view counts all <code class="docutils literal notranslate"><span class="pre">Appended</span></code> and <code class="docutils literal notranslate"><span class="pre">Resolved</span></code> events emitted by all event-sourced actors to the same <code class="docutils literal notranslate"><span class="pre">eventLog</span></code>:</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.ActorRef</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedView</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.VectorTime</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Resolved</span><span class="o">(</span><span class="n">selectedTimestamp</span><span class="k">:</span> <span class="kt">VectorTime</span><span class="o">)</span>

<span class="k">case</span> <span class="k">object</span> <span class="nc">GetAppendCount</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">GetAppendCountReply</span><span class="o">(</span><span class="n">count</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>

<span class="k">case</span> <span class="k">object</span> <span class="nc">GetResolveCount</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">GetResolveCountReply</span><span class="o">(</span><span class="n">count</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">ExampleView</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedView</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">appendCount</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">0L</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">resolveCount</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">0L</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">GetAppendCount</span> <span class="k">=&gt;</span> <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">GetAppendCountReply</span><span class="o">(</span><span class="n">appendCount</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">GetResolveCount</span> <span class="k">=&gt;</span> <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">GetResolveCountReply</span><span class="o">(</span><span class="n">resolveCount</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Appended</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">appendCount</span> <span class="o">+=</span> <span class="mi">1L</span>
    <span class="k">case</span> <span class="nc">Resolved</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">resolveCount</span> <span class="o">+=</span> <span class="mi">1L</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.AbstractEventsourcedView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.VectorTime</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">ExampleView</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedView</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">Long</span> <span class="n">appendCount</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Long</span> <span class="n">resolveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">ExampleView</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnCommand</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">GetAppendCount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">sender</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">GetAppendCountReply</span><span class="o">(</span><span class="n">appendCount</span><span class="o">),</span> <span class="n">getSelf</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">GetResolveCount</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">sender</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">GetResolveCountReply</span><span class="o">(</span><span class="n">resolveCount</span><span class="o">),</span> <span class="n">getSelf</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Appended</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">appendCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Resolved</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">resolveCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Commands</span>
<span class="kd">class</span> <span class="nc">GetAppendCount</span> <span class="o">{</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">GetResolveCount</span> <span class="o">{</span>
<span class="o">}</span>

<span class="c1">// Command replies</span>
<span class="kd">class</span> <span class="nc">GetAppendCountReply</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Long</span> <span class="n">count</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">GetAppendCountReply</span><span class="o">(</span><span class="n">Long</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">GetResolveCountReply</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Long</span> <span class="n">count</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">GetResolveCountReply</span><span class="o">(</span><span class="n">Long</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Events</span>
<span class="kd">class</span> <span class="nc">Appended</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">entry</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Appended</span><span class="o">(</span><span class="n">String</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Resolved</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">VectorTime</span> <span class="n">selectedTimestamp</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Resolved</span><span class="o">(</span><span class="n">VectorTime</span> <span class="n">selectedTimestamp</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">selectedTimestamp</span> <span class="o">=</span> <span class="n">selectedTimestamp</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Event-sourced views handle events in the same way as event-sourced actors by implementing an <code class="docutils literal notranslate"><span class="pre">onEvent</span></code> handler. The <code class="docutils literal notranslate"><span class="pre">onCommand</span></code> handler in the example processes the queries <code class="docutils literal notranslate"><span class="pre">GetAppendCount</span></code> and <code class="docutils literal notranslate"><span class="pre">GetResolveCount</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">ExampleView</span></code> implements the mandatory global unique <code class="docutils literal notranslate"><span class="pre">id</span></code> but doesn’t define an <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code>. A view that doesn’t define an <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code> can consume events from all event-sourced actors on the same event log. If it defines an <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code> it can only consume events from event-sourced actors with the same <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code> (assuming the default <a class="reference internal" href="reference/event-sourcing.html#event-routing"><span class="std std-ref">Event routing</span></a> rules).</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">While event-sourced views maintain view state in-memory, <a class="reference internal" href="reference/event-sourcing.html#ref-event-sourced-writers"><span class="std std-ref">Event-sourced writers</span></a> can be used to persist view state to external databases. A specialization of event-sourced writers are <a class="reference internal" href="reference/event-sourcing.html#ref-event-sourced-processors"><span class="std std-ref">Event-sourced processors</span></a> whose external database is an event log.</p>
</div>
</div>
<div class="section" id="conditional-requests">
<span id="id8"></span><h2>Conditional requests<a class="headerlink" href="#conditional-requests" title="Permalink to this headline">¶</a></h2>
<p>Causal read consistency is the default when reading state from a single event-sourced actor or view. The event stream received by that actor is always causally ordered, hence, it will never see an <em>effect</em> before having seen its <em>cause</em>.</p>
<p>The situation is different when a client reads from multiple actors. Imagine two event-sourced actor replicas where a client updates one replica and observes the updated state with the reply. A subsequent from the other replica, made by the same client, may return the old state which violates causal consistency.</p>
<p>Similar considerations can be made for reading from an event-sourced view after having made an update to an event-sourced actor. For example, an application that successfully appended an entry to <code class="docutils literal notranslate"><span class="pre">ExampleActor</span></code> may not immediately see that update in the <code class="docutils literal notranslate"><span class="pre">appendCount</span></code> of <code class="docutils literal notranslate"><span class="pre">ExampleView</span></code>. To achieve causal read consistency, the view should delay command processing until the emitted event has been consumed by the view. This can be achieved with a <code class="docutils literal notranslate"><span class="pre">ConditionalRequest</span></code>.</p>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">scala.util._</span>
<span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">akka.pattern.ask</span>
<span class="k">import</span> <span class="nn">akka.util.Timeout</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate._</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Append</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">AppendSuccess</span><span class="o">(</span><span class="n">entry</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">updateTimestamp</span><span class="k">:</span> <span class="kt">VectorTime</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
                   <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">currentState</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span>
  <span class="k">override</span> <span class="k">val</span> <span class="n">aggregateId</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Append</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">persist</span><span class="o">(</span><span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">evt</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">AppendSuccess</span><span class="o">(</span><span class="n">entry</span><span class="o">,</span> <span class="n">lastVectorTimestamp</span><span class="o">)</span>
      <span class="c1">// ...</span>
    <span class="o">}</span>
    <span class="c1">// ...</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Appended</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">currentState</span> <span class="k">=</span> <span class="n">currentState</span> <span class="o">:+</span> <span class="n">entry</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">ExampleView</span><span class="o">(</span><span class="k">override</span> <span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">override</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nc">EventsourcedView</span> <span class="k">with</span> <span class="nc">ConditionalRequests</span> <span class="o">{</span>
  <span class="c1">// ...</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">ea</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleActor</span><span class="o">(</span><span class="s">&quot;ea&quot;</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">)))</span>
<span class="k">val</span> <span class="n">ev</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">ExampleView</span><span class="o">(</span><span class="s">&quot;ev&quot;</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">)))</span>

<span class="k">import</span> <span class="nn">system.dispatcher</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="nc">Timeout</span><span class="o">(</span><span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span>

<span class="k">for</span> <span class="o">{</span>
  <span class="nc">AppendSuccess</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">ea</span> <span class="o">?</span> <span class="nc">Append</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)</span>
  <span class="nc">GetAppendCountReply</span><span class="o">(</span><span class="n">count</span><span class="o">)</span>  <span class="k">&lt;-</span> <span class="n">ev</span> <span class="o">?</span> <span class="nc">ConditionalRequest</span><span class="o">(</span><span class="n">timestamp</span><span class="o">,</span> <span class="nc">GetAppendCount</span><span class="o">)</span>
<span class="o">}</span> <span class="n">println</span><span class="o">(</span><span class="s">s&quot;append count = </span><span class="si">$count</span><span class="s">&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.Props</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.pattern.Patterns</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.util.Timeout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">scala.concurrent.ExecutionContextExecutor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">scala.concurrent.Future</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">scala.reflect.ClassTag</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">scala.reflect.ClassTag</span><span class="n">$</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="kn">import static</span> <span class="nn">scala.compat.java8.JFunction.func</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">scala.compat.java8.JFunction.proc</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">ExampleActor</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedActor</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>

  <span class="kd">public</span> <span class="nf">ExampleActor</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getAggregateId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnCommand</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Append</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">persist</span><span class="o">(</span><span class="k">new</span> <span class="n">Appended</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="na">entry</span><span class="o">),</span> <span class="n">ResultHandler</span><span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span>
            <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">getSender</span><span class="o">().</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">AppendSuccess</span><span class="o">(</span><span class="n">evt</span><span class="o">.</span><span class="na">entry</span><span class="o">,</span> <span class="n">getLastVectorTimestamp</span><span class="o">()),</span> <span class="n">getSelf</span><span class="o">())</span>
        <span class="o">)))</span>
        <span class="c1">// ...</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Appended</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">append</span><span class="o">(</span><span class="n">currentState</span><span class="o">,</span> <span class="n">evt</span><span class="o">.</span><span class="na">entry</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Command</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Append</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">entry</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Append</span><span class="o">(</span><span class="n">String</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Command reply</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppendSuccess</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">entry</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">VectorTime</span> <span class="n">updateTimestamp</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">AppendSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">entry</span><span class="o">,</span> <span class="n">VectorTime</span> <span class="n">updateTimestamp</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">updateTimestamp</span> <span class="o">=</span> <span class="n">updateTimestamp</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// Eventsourced-View</span>
<span class="kd">class</span> <span class="nc">ExampleView</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedView</span> <span class="o">{</span>

  <span class="c1">// AbstractEventsourcedView has ConditionalRequests mixed-in by default</span>

  <span class="kd">public</span> <span class="nf">ExampleView</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>

    <span class="c1">// ...</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">ea</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ExampleActor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ExampleActor</span><span class="o">(</span><span class="s">&quot;ea&quot;</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">)));</span>
<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">ev</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">ExampleView</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ExampleView</span><span class="o">(</span><span class="s">&quot;ev&quot;</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">)));</span>

<span class="kd">final</span> <span class="n">Timeout</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">Timeout</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>

<span class="n">Patterns</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span><span class="n">ea</span><span class="o">,</span> <span class="k">new</span> <span class="n">Append</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">),</span> <span class="n">timeout</span><span class="o">)</span>
  <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">func</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">Patterns</span><span class="o">.</span><span class="na">ask</span><span class="o">(</span><span class="n">ev</span><span class="o">,</span> <span class="k">new</span> <span class="n">ConditionalRequest</span><span class="o">(((</span><span class="n">AppendSuccess</span><span class="o">)</span> <span class="n">m</span><span class="o">).</span><span class="na">updateTimestamp</span><span class="o">,</span> <span class="k">new</span> <span class="n">GetAppendCount</span><span class="o">()),</span> <span class="n">timeout</span><span class="o">)),</span> <span class="n">dispatcher</span><span class="o">)</span>
  <span class="o">.</span><span class="na">onComplete</span><span class="o">(</span><span class="n">proc</span><span class="o">(</span><span class="n">result</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;append count = &quot;</span> <span class="o">+</span> <span class="o">((</span><span class="n">GetAppendCountReply</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()).</span><span class="na">count</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}),</span> <span class="n">dispatcher</span><span class="o">);</span>
</pre></div>
</div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">ExampleActor</span></code> includes the event’s vector timestamp in its <code class="docutils literal notranslate"><span class="pre">AppendSuccess</span></code> reply. Together with the actual <code class="docutils literal notranslate"><span class="pre">GetAppendCount</span></code> command, the timestamp is included as condition in a <code class="docutils literal notranslate"><span class="pre">ConditionalRequest</span></code> and sent to the view. For <code class="docutils literal notranslate"><span class="pre">ConditionalRequest</span></code> processing, an event-sourced view must extend the <code class="docutils literal notranslate"><span class="pre">ConditionalRequests</span></code> trait. <code class="docutils literal notranslate"><span class="pre">ConditionalRequests</span></code> internally delays the command, if needed, and only dispatches <code class="docutils literal notranslate"><span class="pre">GetAppendCount</span></code> to the view’s <code class="docutils literal notranslate"><span class="pre">onCommand</span></code> handler if the condition timestamp is in the <em>causal past</em> of the view (which is earliest the case when the view consumed the update event). When running the example with an empty event log, it should print:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">append</span> <span class="n">count</span> <span class="k">=</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Not only event-sourced views but also event-sourced actors, stateful event-sourced writers and processors can extend <code class="docutils literal notranslate"><span class="pre">ConditionalRequests</span></code>. Delaying conditional requests may re-order them relative to other conditional and non-conditional requests.</p>
</div>
</div>
<div class="section" id="event-driven-communication">
<span id="guide-event-driven-communication"></span><h2>Event-driven communication<a class="headerlink" href="#event-driven-communication" title="Permalink to this headline">¶</a></h2>
<p>Earlier sections have already shown one form of event collaboration: <em>state replication</em>. For that purpose, event-sourced actors of the same type exchange their events to re-construct actor state at different locations.</p>
<p>In more general cases, event-sourced actors of different type exchange events to achieve a common goal. They react on received events by updating internal state and producing new events. This form of event collaboration is called <em>event-driven communication</em>. In the following example, two event-actors collaborate in a ping-pong game where</p>
<ul class="simple">
<li>a <code class="docutils literal notranslate"><span class="pre">PingActor</span></code> emits a <code class="docutils literal notranslate"><span class="pre">Ping</span></code> event on receiving a <code class="docutils literal notranslate"><span class="pre">Pong</span></code> event and</li>
<li>a <code class="docutils literal notranslate"><span class="pre">PongActor</span></code> emits a <code class="docutils literal notranslate"><span class="pre">Pong</span></code> event on receiving a <code class="docutils literal notranslate"><span class="pre">Ping</span></code> event</li>
</ul>
<div class="tabbed-code docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// some imports omitted ...</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedView.Handler</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.EventsourcedActor</span>
<span class="k">import</span> <span class="nn">com.rbmhtechnology.eventuate.PersistOnEvent</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Ping</span><span class="o">(</span><span class="n">num</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Pong</span><span class="o">(</span><span class="n">num</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">PingActor</span><span class="o">(</span><span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">completion</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="k">with</span> <span class="nc">PersistOnEvent</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s">&quot;serve&quot;</span> <span class="k">=&gt;</span> <span class="n">persist</span><span class="o">(</span><span class="nc">Ping</span><span class="o">(</span><span class="mi">1</span><span class="o">))(</span><span class="nc">Handler</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Pong</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span> <span class="k">if</span> <span class="o">!</span><span class="n">recovering</span> <span class="k">=&gt;</span> <span class="n">completion</span> <span class="o">!</span> <span class="s">&quot;done&quot;</span>
    <span class="k">case</span> <span class="nc">Pong</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>  <span class="k">=&gt;</span> <span class="n">persistOnEvent</span><span class="o">(</span><span class="nc">Ping</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">PongActor</span><span class="o">(</span><span class="k">val</span> <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">val</span> <span class="n">eventLog</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nc">EventsourcedActor</span> <span class="k">with</span> <span class="nc">PersistOnEvent</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onCommand</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
  <span class="o">}</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">onEvent</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Ping</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">persistOnEvent</span><span class="o">(</span><span class="nc">Pong</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">pingActor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">PingActor</span><span class="o">(</span><span class="s">&quot;ping&quot;</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">,</span> <span class="n">system</span><span class="o">.</span><span class="n">deadLetters</span><span class="o">)))</span>
<span class="k">val</span> <span class="n">pongActor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">PongActor</span><span class="o">(</span><span class="s">&quot;pong&quot;</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">)))</span>

<span class="n">pingActor</span> <span class="o">!</span> <span class="s">&quot;serve&quot;</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.ActorSystem</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">akka.actor.Props</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.AbstractEventsourcedActor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rbmhtechnology.eventuate.ResultHandler</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">akka.actor.ActorRef.noSender</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">PingActor</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedActor</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">completion</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">PingActor</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">completion</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">completion</span> <span class="o">=</span> <span class="n">completion</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnCommand</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">matchEquals</span><span class="o">(</span><span class="s">&quot;serve&quot;</span><span class="o">,</span> <span class="n">cmd</span> <span class="o">-&gt;</span> <span class="n">persist</span><span class="o">(</span><span class="k">new</span> <span class="n">Ping</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">ResultHandler</span><span class="o">.</span><span class="na">none</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Pong</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">evt</span><span class="o">.</span><span class="na">num</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isRecovering</span><span class="o">(),</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">completion</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">&quot;done&quot;</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Pong</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">persistOnEvent</span><span class="o">(</span><span class="k">new</span> <span class="n">Ping</span><span class="o">(</span><span class="n">evt</span><span class="o">.</span><span class="na">num</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">PongActor</span> <span class="kd">extends</span> <span class="n">AbstractEventsourcedActor</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nf">PongActor</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">ActorRef</span> <span class="n">eventLog</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AbstractActor</span><span class="o">.</span><span class="na">Receive</span> <span class="nf">createOnEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">receiveBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">Ping</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">evt</span> <span class="o">-&gt;</span> <span class="n">persistOnEvent</span><span class="o">(</span><span class="k">new</span> <span class="n">Pong</span><span class="o">(</span><span class="n">evt</span><span class="o">.</span><span class="na">num</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Ping</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">num</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Ping</span><span class="o">(</span><span class="n">Integer</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Pong</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">num</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Pong</span><span class="o">(</span><span class="n">Integer</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">pingActor</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">PingActor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">PingActor</span><span class="o">(</span><span class="s">&quot;ping&quot;</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">,</span> <span class="n">system</span><span class="o">.</span><span class="na">deadLetters</span><span class="o">())));</span>
<span class="kd">final</span> <span class="n">ActorRef</span> <span class="n">pongActor</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="na">actorOf</span><span class="o">(</span><span class="n">Props</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">PongActor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">PongActor</span><span class="o">(</span><span class="s">&quot;pong&quot;</span><span class="o">,</span> <span class="n">eventLog</span><span class="o">)));</span>

<span class="n">pingActor</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="s">&quot;serve&quot;</span><span class="o">,</span> <span class="n">noSender</span><span class="o">());</span>
</pre></div>
</div>
</div>
<p>The ping-pong game is started by sending the <code class="docutils literal notranslate"><span class="pre">PingActor</span></code> a <code class="docutils literal notranslate"><span class="pre">”serve”</span></code> command which <code class="docutils literal notranslate"><span class="pre">persist</span></code>s the first <code class="docutils literal notranslate"><span class="pre">Ping</span></code> event. This event however is not consumed by the emitter but rather by the <code class="docutils literal notranslate"><span class="pre">PongActor</span></code>. The <code class="docutils literal notranslate"><span class="pre">PongActor</span></code> reacts on the <code class="docutils literal notranslate"><span class="pre">Ping</span></code> event by emitting a <code class="docutils literal notranslate"><span class="pre">Pong</span></code> event. Other than in previous examples, the event is not emitted in the actor’s <code class="docutils literal notranslate"><span class="pre">onCommand</span></code> handler but in the <code class="docutils literal notranslate"><span class="pre">onEvent</span></code> handler. For that purpose, the actor has to mixin the <code class="docutils literal notranslate"><span class="pre">PersistOnEvent</span></code> trait and use the <code class="docutils literal notranslate"><span class="pre">persistOnEvent</span></code> method. The emitted <code class="docutils literal notranslate"><span class="pre">Pong</span></code> too isn’t consumed by its emitter but rather by the <code class="docutils literal notranslate"><span class="pre">PingActor</span></code>, emitting another <code class="docutils literal notranslate"><span class="pre">Ping</span></code>, and so on. The game ends when the <code class="docutils literal notranslate"><span class="pre">PingActor</span></code> received the 10th <code class="docutils literal notranslate"><span class="pre">Pong</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The ping-pong game is <strong>reliable</strong>. When an actor crashes and is re-started, the game is reliably resumed from where it was interrupted. The <code class="docutils literal notranslate"><span class="pre">persistOnEvent</span></code> method is idempotent i.e. no duplicates are written under failure conditions and later event replay. When deployed at different location, the ping-pong actors are also <strong>partition-tolerant</strong>. When their game is interrupted by a network partition, it is automatically resumed when the partition heals.</p>
<p class="last">Furthermore, the actors don’t need to care about idempotency in their business logic i.e. they can assume to receive a <strong>de-duplicated</strong> and <strong>causally-ordered</strong> event stream in their <code class="docutils literal notranslate"><span class="pre">onEvent</span></code> handler. This is a significant advantage over at-least-once delivery based communication with <a class="reference external" href="latest/api/index.html#com.rbmhtechnology.eventuate.ConfirmedDelivery">ConfirmedDelivery</a>, for example, which can lead to duplicates and message re-ordering.</p>
</div>
<p>In a more real-world example, there would be several actors of different type collaborating to achieve a common goal, for example, in a distributed business process. These actors can be considered as event-driven and event-sourced <em>microservices</em>, collaborating on a causally ordered event stream in a reliable and partition-tolerant way. Furthermore, when partitioned, they remain available for local writes and automatically catch up with their collaborators when the partition heals.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Further <code class="docutils literal notranslate"><span class="pre">persistOnEvent</span></code> details are described in the <a class="reference external" href="latest/api/index.html#com.rbmhtechnology.eventuate.PersistOnEvent">PersistOnEvent</a> API docs.</p>
</div>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><code class="docutils literal notranslate"><span class="pre">EventsourcedActor</span></code>s and <code class="docutils literal notranslate"><span class="pre">EventsourcedView</span></code>s that have an undefined <code class="docutils literal notranslate"><span class="pre">aggregateId</span></code> can consume events from all other actors on the same event log.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>Attached update timestamps are not version vectors because Eventuate uses <a class="reference external" href="http://en.wikipedia.org/wiki/Vector_clock">vector clock update rules</a> instead of <a class="reference external" href="http://en.wikipedia.org/wiki/Version_vector">version vector update rules</a>. Consequently, update timestamp equivalence cannot be used as criterion for replica convergence.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[3]</a></td><td>A formal approach to automatically <em>merge</em> concurrent versions of application state are convergent replicated data types (CvRDTs) or state-based CRDTs.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[4]</a></td><td>Distributed lock acquisition or leader election require an external coordination service like <a class="reference external" href="http://zookeeper.apache.org/">ZooKeeper</a>, for example, whereas static rules do not.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
		    
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="reference.html" class="float-right" title="Reference">Next</a>
      
      
        <a href="architecture.html" title="Architecture">Previous</a>
      
    </div>
  
        </div>
	  </div>
    <div class="wrapper-footer">
<footer>
  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 - 2016 Red Bull Media House.  | <a href="http://rbmhtechnology.github.io/imprint" target="_blank">Imprint</a> | <a href="http://rbmhtechnology.github.io/termsconditions" target="_blank">Terms &amp; Conditions</a> | <a href="http://rbmhtechnology.github.io/dataprivacypolicy" target="_blank">Data Privacy Policy</a> 
    </p>
  </div>

</footer>
</div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.11-SNAPSHOT',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/tabbedcode.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>